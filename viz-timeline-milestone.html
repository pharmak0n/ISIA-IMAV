<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAV - Milestone</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Reduced custom CSS, keeping only what Bootstrap doesn't provide */
        body {
            padding-top: 70px;
        }
        .timeline-wrapper {
            overflow-x: auto;
            margin: 0 -25px;
            /* Simple scrollbar styling for better aesthetics */
            scrollbar-width: thin;
        }
        .timeline-wrapper .year-slot {
            border-left: 2px solid #000000;
            margin-left: 20px;
        }
        .timeline-wrapper::-webkit-scrollbar {
            height: 12px;
        }
        .timeline-wrapper::-webkit-scrollbar-track {
            border-radius: 10px;
        }
        .timeline-wrapper::-webkit-scrollbar-thumb {
            border-radius: 10px;
            border: 3px solid #e9ecef;
        }
        .year-marker {
            position: sticky;
            top: 10px;
            z-index: 1;
            padding-bottom: 1rem;
        }
        .card-item {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body data-bs-theme="dark" class="bg-primary">
    <nav class="navbar navbar-expand-xs fixed-top bg-primary">
        <div class="mx-3 d-flex flex-row justify-content-start align-items-center">
            <a class="btn btn-outline-primary" href="index.html">&larr;</a>
            <h1 class="text-dark m-0 ms-3">Milestone</h1>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div id="timeline-wrapper" class="timeline-wrapper">
            <div id="timeline" class="row flex-nowrap gx-4"></div>
        </div>
    </div>

    <!-- Offcanvas Sidebar for Details -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="detail-sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarLabel">Dettagli Evento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <h4 id="detail-title"></h4>
            <p id="detail-date" class="text-muted"></p>
            <hr>
            <p id="detail-desc"></p>
            <p id="detail-source" class="small"></p>
            <p id="detail-cultural" class="small"></p>
            <p id="detail-link" class="small"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sidebarEl = document.getElementById('detail-sidebar');
        const sidebar = new bootstrap.Offcanvas(sidebarEl);

        const detailTitle = d3.select("#detail-title");
        const detailDate = d3.select("#detail-date");
        const detailDesc = d3.select("#detail-desc");
        const detailSource = d3.select("#detail-source");
        const detailCultural = d3.select("#detail-cultural");
        const detailLink = d3.select("#detail-link");

        d3.json("data/d3_timeline_data_milestone.json").then(function(data) {
            const cleanData = data.filter(d => d.data);
            cleanData.forEach(d => {
                const dateParts = d.data.split('-');
                const year = parseInt(dateParts[0], 10);
                let month = 0; // Default to January
                let day = 1;   // Default to 1st

                if (dateParts.length > 1) {
                    // If the second part is a 4-digit number, it's a year range (e.g., "2000-2004")
                    // We'll just use the starting year for simplicity.
                    if (dateParts[1].length !== 4) {
                        month = parseInt(dateParts[1], 10) - 1;
                        if (dateParts.length > 2) {
                            day = parseInt(dateParts[2], 10);
                        }
                    }
                }
                d.fullDate = new Date(year, month, day);
            });

            const validData = cleanData.filter(d => d.fullDate && !isNaN(d.fullDate.getTime()));
            validData.sort((a, b) => a.fullDate - b.fullDate);

            const groupedByYear = d3.group(validData, d => d.fullDate.getFullYear());
            const sortedYears = Array.from(groupedByYear.keys()).sort((a, b) => a - b);

            const timeline = d3.select("#timeline");

            sortedYears.forEach(year => {
                const events = groupedByYear.get(year);
                // Use Bootstrap column for each year
                const yearSection = timeline.append('div').attr('class', 'year-slot col-7 col-md-5 col-lg-4 col-xl-3');
                
                yearSection.append('h2')
                    .attr('class', 'year-marker text-dark')
                    .text(year);

                // Create Bootstrap cards for each event
                yearSection.selectAll('.card-item')
                    .data(events)
                    .enter()
                    .append('div')
                    .attr('class', 'card card-item mb-3')
                    .on('click', (event, d) => showDetails(d))
                    .html(d => {
                        const dateString = d.fullDate.toLocaleDateString("it-IT", {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        });
                        return `
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">${dateString}</h6>
                            <p class="card-title fw-bold">${d.titolo}</p>
                        </div>
                        `
                    });
                yearSection.append('h2')
                    .attr('class', 'year-marker text-dark')
                    .text(year);  
            });

        }).catch(function(error) {
            console.error("Errore nel caricamento del file JSON:", error);
        });

        function showDetails(d) {
            const dateString = d.fullDate.toLocaleDateString("it-IT", {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            detailTitle.text(d.titolo);
            detailDate.text(dateString);
            detailDesc.text(d.descrizione);
            detailSource.html(d.fonte ? `<strong>Fonte:</strong> ${d.fonte}` : '');
            detailCultural.html(d.riferimento_culturale ? `<strong>Riferimento Culturale:</strong> ${d.riferimento_culturale}` : '');
            detailLink.html(d.link ? `<strong>Link:</strong> <a href="${d.link}" target="_blank">${d.link}</a>` : '');
            sidebar.show();
        }

    </script>
</body>
</html>