<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafico a Bolle D3.js - Film e Tag</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f4f4f4;
        }

        svg {
            width: 100vw;
            height: 100vh;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .node {
            stroke: #fff;
            stroke-width: 1.5px;
            cursor: grab;
        }

        .node:active {
            cursor: grabbing;
        }

        .label {
            font-size: 10px;
            font-family: sans-serif;
            pointer-events: none;
            text-anchor: middle;
            fill: #333;
        }
        
        .offcanvas-body {
            display: flex;
            flex-direction: column;
        }

        #detail-panel {
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
    <svg id="bubble-chart"></svg>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarLabel">Dettagli</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Pannello Lista Opere -->
            <div id="list-panel">
                <h2 id="list-title"></h2>
                <ul id="item-list" class="list-group"></ul>
            </div>

            <!-- Pannello Dettaglio Opera -->
            <div id="detail-panel">
                <button class="btn btn-light mb-3" id="back-btn">&larr; Indietro</button>
                <h2 id="detail-title"></h2>
                <div id="detail-content"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. Setup Iniziale ---
        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select("#bubble-chart")
            .attr("viewBox", [-width / 2, -height / 2, width, height]);

        // --- Sidebar Elements ---
        const sidebarEl = document.getElementById('sidebar');
        const sidebar = new bootstrap.Offcanvas(sidebarEl);
        const listPanel = d3.select("#list-panel");
        const detailPanel = d3.select("#detail-panel");
        const listTitle = d3.select("#list-title");
        const itemList = d3.select("#item-list");
        const detailTitle = d3.select("#detail-title");
        const detailContent = d3.select("#detail-content");
        const backBtn = d3.select("#back-btn");

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // --- 3. Caricamento Dati ---
        d3.json("d3_bubble_graph_note.json").then(function(graph) {

            const nodes = graph.nodes;
            const links = graph.links;

            const nodeById = new Map(nodes.map(node => [node.id, node]));

            // --- 4. Scala di Dimensioni (Radius) ---
            const maxTagValue = d3.max(nodes.filter(n => n.type === 'tag'), d => d.value) || 1;
            const radiusScale = d3.scaleSqrt().domain([1, maxTagValue]).range([8, 40]);

            function getNodeRadius(d) {
                if (d.type === 'item') return 6;
                return radiusScale(d.value);
            }

            // --- 5. Simulazione Fisica ---
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(40))
                .force("charge", d3.forceManyBody().strength(-100))
                .force("collide", d3.forceCollide().radius(d => getNodeRadius(d) + 2))
                .force("center", d3.forceCenter(0, 0).strength(0.05));

            // --- 6. Render SVG ---
            const container = svg.append("g");

            const link = container.append("g").attr("class", "links").selectAll("line").data(links).join("line").attr("class", "link");
            
            const node = container.append("g").attr("class", "nodes").selectAll("circle").data(nodes).join("circle")
                .attr("class", "node")
                .attr("r", d => getNodeRadius(d))
                .attr("fill", d => {
                    if (d.type === 'tag') return 'red';
                    if (d.type === 'item') return 'black';
                    return '#999';
                })
                .attr("data-bs-toggle", "tooltip")
                .attr("data-bs-placement", "top")
                .attr("title", d => {
                    let content = `${d.id}\nTipo: ${d.group}`;
                    if (d.type === 'tag') content += `\nConnessioni: ${d.value}`;
                    return content;
                })
                .call(drag(simulation));

            const label = container.append("g").attr("class", "labels").selectAll("text").data(nodes.filter(n => n.type === 'tag')).join("text")
                .attr("class", "label")
                .text(d => d.id);

            // --- 7. InterattivitÃ  (Zoom) ---
            const zoom = d3.zoom()
                .scaleExtent([0.1, 8])
                .on("zoom", (event) => {
                    container.attr("transform", event.transform);
                });

            svg.call(zoom);

            node.on("click", (event, d) => {
                if (d.type === 'tag') {
                    showConnectedItems(d);
                }
            });
            
            // Re-initialize tooltips after D3 creates the nodes
            const newTooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            newTooltipTriggerList.forEach(function (tooltipTriggerEl) {
                 new bootstrap.Tooltip(tooltipTriggerEl);
            });


            // --- 8. Aggiornamento Simulazione ---
            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                node.attr("cx", d => d.x).attr("cy", d => d.y);
                label.attr("x", d => d.x).attr("y", d => d.y + getNodeRadius(d) + 12);
            });

            // --- 9. Funzioni Sidebar ---
            
            function showConnectedItems(tagNode) {
                const connectedItemIds = new Set();
                links.forEach(link => {
                    const sourceNode = link.source;
                    const targetNode = link.target;
                    if (sourceNode.id === tagNode.id && targetNode.type === 'item') connectedItemIds.add(targetNode.id);
                    else if (targetNode.id === tagNode.id && sourceNode.type === 'item') connectedItemIds.add(sourceNode.id);
                });

                const connectedItems = Array.from(connectedItemIds).map(id => nodeById.get(id));

                itemList.html(''); // Pulisce la lista
                if (connectedItems.length > 0) {
                    listTitle.text(`Opere collegate a "${tagNode.id}"`);
                    connectedItems.sort((a, b) => a.id.localeCompare(b.id)); // Ordina alfabeticamente
                    
                    connectedItems.forEach(itemNode => {
                        const li = itemList.append('li').attr('class', 'list-group-item list-group-item-action');
                        if (itemNode.date) {
                            li.append('small').text(new Date(itemNode.date).toLocaleString());
                        }
                        li.append('p').text(itemNode.id);
                        li.datum(itemNode); // Associa i dati completi all'elemento li
                        li.on('click', (event, d) => {
                            showItemDetails(d);
                        });
                    });
                } else {
                    listTitle.text(`Nessuna opera per "${tagNode.id}"`);
                }

                detailPanel.style('display', 'none');
                listPanel.style('display', 'block');
                sidebar.show();
            }

            function showItemDetails(itemNode) {
                detailTitle.text(itemNode.id);
                
                let content = `
                    <p>${itemNode.descrizione || 'Nessuna descrizione disponibile.'}</p>
                `;

                if (itemNode.date) {
                    content = `<h4>${new Date(itemNode.date).toLocaleString()}</h4>` + content;
                }

                if (itemNode.url && itemNode.url.startsWith('http')) {
                    content += `<strong>URL:</strong><p><a href="${itemNode.url}" target="_blank">Vai all'articolo</a></p>`;
                }

                detailContent.html(content);

                listPanel.style('display', 'none');
                detailPanel.style('display', 'block');
            }

            backBtn.on('click', () => {
                detailPanel.style('display', 'none');
                listPanel.style('display', 'block');
            });

            svg.on('click', (event) => {
                if (event.target.tagName === 'circle') return;
                sidebar.hide();
            });

        }).catch(function(error) {
            console.error("Error loading the JSON file:", error);
        });

        // --- 10. Funzioni di Supporto (Drag) ---
        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null; d.fy = null;
            }
            return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
        }

    </script>
</body>
</html>